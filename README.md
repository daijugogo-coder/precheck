# 事前チェックシステム（在庫不足チェック）

本ツールは、CSV / Excel ファイルをアップロードし、
以下の事前チェックを行う Streamlit アプリである。

* チャージ金額チェック
* 売上日付チェック
* 在庫不足チェック（現在庫 vs 変動数）

本アプリは**社内利用を前提**としており、Streamlit 上で動作する。

---

## 概要

本アプリは、売上・在庫関連の複数ファイルを入力として受け取り、
**在庫不足の事前検知（OK / NG 判定）**を目的とする。

PowerQuery で構築されていた既存チェック処理を Python / Streamlit に移植したものであり、
**PowerQuery の完全再現は目的としない**。

---

## 入力ファイル

本アプリは以下 **9ファイル**を入力として受け取る。

### 売上・在庫データ

* GICL_URI_.csv
* GICL_SHI_.csv
* GICL_TNA_.csv
* GICL_IDO_.csv
* 現在庫照会（商品別）.xlsx

### マスタデータ

* 汎用コード変換マスタ_857001.csv
* 汎用コード変換マスタ_857002.csv
* 汎用コード変換マスタ_857003.csv
* 商品構成マスタ_13000.csv

※ 9ファイルの解析は、PC の負荷やファイルサイズによって **30〜60秒以上** かかる場合がある。
反応が遅くても処理が継続している可能性があるため、途中で中断しないこと。

---

## 現在の状態（2026-01-07 時点）

* app.py は約 1,100 行
* UI / UX は概ね完成している
* ドラッグ＆ドロップによるファイルアップロードは正常動作
* Browse Files によるアップロードも動作確認済み
* 在庫不足チェックは **エラーではなく OK / NG 判定として出力**される

---

## 作業再開時の前提（重要）

今後このプロジェクトを修正・拡張する際は、以下を**厳守すること**。

* 本 README.md の内容を**唯一の仕様**とする
* 過去スレッド・過去実装・Copilot の推測は参照しない
* **現在の app.py（2026-01-07 時点）を正とする**
* 新しい関数名・列名・ロジックを推測で追加しない
* 修正は「最小差分」を原則とする
* PowerQuery の中間列ロジックを Python に再現しようとしない

※「PowerQuery ではこうだったはず」という推測は禁止

---

## 意図している正しい仕様（重要）

* 現在庫照会（商品別）Excel の「実在庫数量」を正とする
* CL在庫・疑似列・PowerQuery 中間列は使用しない
* 在庫不足チェックは以下の判定のみを行う

```
実在庫数量 + 変動数 < 0 → 在庫不足（NG）
```

* 突合キーは以下について **Trim（前後空白除去）後に比較**する

  * 事業CD
  * 保管場所CD
  * 商品CD
  * TMS商品CD

* 使用する列・ロジックは**実データに存在するもののみ**とする

---

## 商品構成マスタ（13000）の扱い

* GICL_URI_.csv 内の商品コードが **パック商品CD** に該当する場合、
  商品構成マスタ_13000.csv を用いて **内訳商品CD に展開**する
* 展開後の商品コードを用いて、以降の在庫判定・突合を行う

---

## 既知の不具合（整理済）

### 未定義関数の整理

以下の関数は PowerQuery 移植過程または Copilot により混入したものであり、
現在の仕様では使用しない。

* process_uri_uri
* process_uri_cancel
* merge_all_hendo

※ 呼び出し元を含めて整理済み

---

## 今後の作業予定（優先順）

1. 軽微な UI 文言・説明の最終調整
2. 入力ファイルチェックのエラーメッセージ整理
3. 社内デプロイ・運用手順の明文化

---

## 今回は対応しないこと（意図的に後回し）

* SonarLint の Cognitive Complexity 警告
* 定数化（文字列リテラルの共通化）
* 大規模な関数分割・設計変更
* UI の細かいデザイン調整

---

## 補足（AI / Copilot 向けメモ）

* 本プロジェクトは PowerQuery の完全再現を目的としない
* **今の app.py を正**とする
* 推測で列・関数・処理を追加しないこと
* 実データに存在しない要素を前提にしないこと
