README.md と最新の app.py を前提に作業したい。
README.md の内容を唯一の仕様とし、過去スレッドの文脈は参照しないでほしい。

目的：
- 未定義関数の整理
- 在庫不足チェックをエラーではなく OK/NG 判定にする
- Browse Files のアップロード不具合を直す

禁止：
- 推測で関数・列・ロジックを追加すること
- PowerQuery の中間列や CL在庫を復活させること
- 大規模リファクタ

まず README.md を読んで、やるべき作業の整理から始めてほしい。



# 事前チェックシステム（在庫不足チェック）

本ツールは、CSV / Excel ファイルをアップロードし、
以下の事前チェックを行う Streamlit アプリである。

- チャージ金額チェック
- 売上日付チェック
- 在庫不足チェック（現在庫 vs 変動数）

本アプリは社内利用を前提としており、Streamlit 上で動作する。


---

## 現在の状態（2026-01-06 時点）

- app.py は約 1,100 行
- UI/UX は概ね完成している
- ドラッグ＆ドロップによるファイルアップロードは動作する
- Browse Files によるアップロードは動作不安定（要修正）
- 在庫不足チェックは、結果ではなくエラーとして出力される場合がある

※ PowerQuery から Python へ移植した過程で、不要な関数呼び出しや
   未定義関数が混入している可能性がある。


---

## 作業再開時の前提（重要）

今後このプロジェクトを修正・拡張する際は、以下を**厳守すること**。

- 本 README.md の内容を唯一の仕様とする
- 過去スレッド・過去実装・Copilot の推測は参照しない
- **現在の app.py（2026-01-06 時点）を正とする**
- 新しい関数名・列名・ロジックを推測で追加しない
- 修正は「最小差分」を原則とする
- PowerQuery の中間列ロジックを Python に再現しようとしない

※「昔こうだったはず」「PowerQueryでは〜」という推測は禁止


---

## 意図している正しい仕様（重要）

- 現在庫照会（商品別）Excel の「実在庫数量」を正とする
- CL在庫・疑似列・中間列は使用しない
- 在庫不足チェックは以下の判定のみを行う

実在庫数量 + 変動数 < 0 → 在庫不足（NG）


- 突合キーは以下について **Trim（前後空白除去）後に比較**する
  - 事業CD
  - 保管場所CD
  - 商品CD
  - TMS商品CD

- 列名やロジックは「実データに存在するもののみ」を使用する


---

## 既知の不具合

### 1. 未定義関数が存在する

以下の関数が呼び出されているが、定義が存在しない。

- process_uri_uri
- process_uri_cancel
- merge_all_hendo

これらは PowerQuery 移植過程の名残、または Copilot による誤生成と思われる。
**削除または呼び出し元の整理が必要。**


### 2. 在庫不足チェックがエラーになる場合がある

- 在庫不足の結果を返すべき箇所で例外が発生する
- 本来は OK / NG 判定として扱うべき

→ 例外処理と判定ロジックの切り分けが必要


### 3. Browse Files で選択したファイルが認識されない

- ドラッグ＆ドロップは認識される
- Browse Files ではアップロード後にファイルが認識されない場合がある

→ file_uploader の key 設計、再描画処理の見直しが必要


---

## 今後の作業予定（優先順）

1. 未定義関数の整理
   - process_uri_uri
   - process_uri_cancel
   - merge_all_hendo

2. 在庫不足チェックを「結果返却（OK / NG）」に修正
   - エラー表示ではなく判定結果として扱う

3. Browse Files 不具合の修正
   - file_uploader 周りの再描画・key 設計の整理

4. UI/UX の最終調整
   - ドラッグ＆ドロップエリアの視認性
   - セクション構成の微調整


---

## 今回は対応しないこと（意図的に後回し）

以下はロジック安定後に対応する。

- SonarLint の Cognitive Complexity 警告
- 定数化（文字列リテラルの共通化）
- 大規模な関数分割・設計変更
- UI の細かいデザイン調整


---

## 補足（AI / Copilot 向けメモ）

- 本プロジェクトは PowerQuery の完全再現を目的としない
- 「今の app.py を正」とする
- 推測で列・関数・処理を追加しないこと
- 実データに存在しない要素を前提にしないこと

