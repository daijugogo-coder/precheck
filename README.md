# 在庫不足チェックシステム

## 概要

ExcelマクロからPython + Streamlitに移行した在庫過不足チェックシステムです。
店舗×商品の在庫変動データと現在庫を比較し、在庫不足を検出します。

## プロジェクト背景

- **移行前**: Excelマクロ (Power Query) で固定のファイルサーバから自動読み込み
- **移行後**: Streamlit Webアプリでファイルをドラッグ&ドロップして処理
- **完全互換**: Power Queryのロジックを忠実に再現し、同じ結果を出力

## 入力ファイル

### 在庫変動データ (CSV × 4ファイル)
1. **GICL_SHI_.csv** - 仕入データ
2. **GICL_IDO_.csv** - 移動データ（店舗間移動）
3. **GICL_URI_.csv** - 売上データ
4. **GICL_TNA_.csv** - 棚卸データ

**特記事項**:
- エンコーディング: Shift-JIS (CP932)
- 改行コード: LF (CRLFではない)
- カラム数: 31列

### 現在庫データ
5. **現在庫照会（商品別）.xlsx** - 実在庫データ（Excelファイル）

### マスタデータ (CSV × 3ファイル)
6. **汎用コード変換マスタ_857001.csv** - 取次店コードマスタ（店舗倉庫区分、事業CD等の変換）
7. **汎用コード変換マスタ_857002.csv** - 商品コードマスタ（TMSコード変換）
8. **汎用コード変換マスタ_857003.csv** - 仕入先コードマスタ

## 処理フロー

Power Queryの処理ロジックを完全再現しています。

### 1. データ読み込みとマスタ変換

各在庫変動データ（仕入・移動・売上・棚卸）に対して以下を実行：

**仕入データ処理:**
- マスタ857001で取次店コード→店舗倉庫区分・事業CD・保管場所CDに変換（Inner Join）
- 店舗倉庫区分='1'（店舗のみ）でフィルタ
- マスタ857002で商品コード→TMS商品CDに変換（Left Outer Join）
- 受払種別フィルタ: 倉庫へ返品、入荷、入荷(システム自動)、返品キャンセル、返品不備
- 除外商品: ZUA292、ZUA34Q～ZUA34W
- **個体情報** (IMEI/ICCID/シリアルあり): 倉庫へ返品なら-1、それ以外は1
- **アクセサリ** (シリアルなし): 元の数量をそのまま使用

**移動データ処理:**
- 移動元・移動先それぞれでマスタ857001と結合
- マスタ857002でTMS商品CD変換
- **出庫**: 移動元店舗、入庫予定数×-1
- **入庫**: 移動先店舗、入庫予定数×1

**売上データ処理:**
- マスタ857001・857002で変換
- 収納種別が「販売」なら-1、それ以外は1
- **個体情報**: メーカーあり（Apple Inc.-SBS、ｿﾌﾄﾊﾞﾝｸｾﾚｸｼｮﾝ除く）
- **SBアクセサリ**: TGで始まる店舗、上記メーカー
- **サービス**: 商品分類=サービス

**棚卸データ処理:**
- マスタ857001・857002で変換
- 店舗倉庫区分='1'でフィルタ
- 除外商品: ZUA292、ZUA34Q～ZUA34W
- USIMカード除外

### 2. データ集計

各処理済みデータを結合し、以下でグループ化・合計：
- 取次店コード × TMS商品CD

これが**GINIEPOS変動数**となります。

### 3. 在庫不足判定

```
判定 = CL実在庫数（現在庫照会） + 変動数（GINIEPOS変動数）
```

- 判定 < 0 → **在庫不足**
- 除外: BB-RQ8POU1740、ZUA292、Z00014、POS-で始まる商品

### 4. 処理結果の理論

**変動数の意味:**
- 仕入: プラス（在庫増）
- 売上: マイナス（在庫減）
- 移動出庫: マイナス（在庫減）
- 移動入庫: プラス（在庫増）
- 棚卸: 調整数量

**判定の意味:**
- 判定 = 現在庫 + 変動数
- 判定 < 0 → 理論上、在庫がマイナス（在庫不足）

## 出力

### 在庫不足結果

以下の情報を含むテーブルを表示：
- 取次店コード / 取次店名
- TMS商品CD
- 変動数（GINIEPOS変動数）
- CL実在庫数（現在庫照会の実在庫）
- 判定（現在庫+変動数）

**CSVダウンロード機能付き**

## 技術スタック

- **Python 3.14**
- **Streamlit** - Webアプリフレームワーク
- **pandas** - データ処理
- **openpyxl** - Excel読み込み

## 使い方

1. Streamlitアプリを起動（下記コマンド）
2. ブラウザで http://localhost:8502 にアクセス
3. **8つのファイルをまとめてドラッグ&ドロップ**
   - ファイル名から自動判定（SHI, IDO, URI, TNA, 857001など）
4. 「在庫チェック実行」ボタンをクリック
5. 在庫不足がある商品のリストが表示される
6. 結果をCSVでダウンロード可能

## アプリケーションの起動

```bash
streamlit run app.py --server.port 8502
```

または仮想環境の場合：

```bash
C:/Users/316926/Desktop/SB在庫不足チェック/.venv/Scripts/streamlit.exe run app.py --server.port 8502
```

## プロジェクト構成

```text
.
├── README.md                          # このファイル
├── app.py                             # Streamlitメインアプリケーション（Power Query完全準拠）
├── requirements.txt                   # 必要なパッケージリスト
├── .venv/                             # Python仮想環境
└── 3代目襲名-在庫不足チェック.xlsm      # 元のExcelマクロファイル（参考用）
```

## 注意事項

- **CSVファイル形式**:
  - 在庫変動データ（SHI, IDO, URI, TNA）: Shift-JIS (CP932)、LF改行
  - マスタファイル（857001, 857002, 857003）: UTF-8、CRLF改行
- ファイル名に識別可能な文字列（SHI、IDO、URI、TNA、857001等）を含めてください
- 大量のデータを処理するため、初回実行時は時間がかかる場合があります

## ライセンス

社内利用限定

## 更新履歴

- **2026/01/05** - Excelマクロ（Power Query）からPython + Streamlitへの移行完了
  - Power Queryの全ロジックを忠実に再現
  - 1つのアップロード欄で8ファイルをまとめて処理
  - ファイル名から自動判定機能を実装
  - 在庫不足判定ロジック完全動作確認済み

## 技術的な特記事項

### データ型の統一

事業CDが数値型と文字列型で混在していたため、全て文字列型に統一して処理しています。

### Power Queryとの完全互換性

以下のPower Queryのクエリロジックを完全再現：
- 仕入データ（個体情報・アクセサリ）
- 移動データ（出庫・入庫）
- 売上データ（個体情報・SBアクセサリ・サービス）
- 棚卸データ（グループ化）
- GINIEPOS変動数（全データ結合・集計）
- 判定結果（現在庫照会との比較）
